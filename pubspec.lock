aryIndex),e=IDBKeyRange.bound(n,t,!1,!0);this.removeFromCursor(f.openCursor(e),r,u)},r):r(new Error("removeRangeOnSecondaryKey: Index name is missing"))}getAll(n,t){this.safeDbOperation("getAll",null,"readonly",n,(n,t,i)=>this.queryFromCursor(n.openCursor(),t,i),t)}close(){r(this._databaseName,"close requested");this.innerClose()}innerClose(){if(i._requestsInProgress>0)r(this._databaseName,"delaying close because of "+i._requestsInProgress+" requests in progress"),this._closePending=!0;else for(let t of i._allInstances)t._database&&(n.safeExecute(()=>t._database.close(),this._databaseName+".close"),r(t._databaseName,"close completed"),t._database=null,t.onClosed())}queryFromCursor(n,t,i){let r=[];n.onsuccess=n=>{let i=n.target.result;i&&r.push({key:i.primaryKey,value:i.value});i&&r.length!=f?i.continue():t(r)};n.onerror=i}removeFromCursor(n,t,i){let r=0;n.onsuccess=n=>{let i=n.target.result;i&&(i.delete(),r+=1);i&&r!=f?i.continue():t(null)};n.onerror=i}safeDbOperation(n,t,f,e,o,s){r(this._databaseName,n+" requested"+(t?" "+t:""));i._requestsInProgress+=1;let c=u=>{r(this._databaseName,n+" completed "+(t?t+" ":"")),i._requestsInProgress-=1,e(u),this._closePending&&i._requestsInProgress==0&&this.innerClose()},h=n=>{i._requestsInProgress-=1,s(n),this._closePending&&i._requestsInProgress==0&&this.innerClose()};try{if(this._database){let t=this._database.transaction(this._storeName,f).objectStore(this._storeName);o(t,c,u(n+".onError",h))}else h(new Error(n+" Database not initialized"))}catch(l){h(l)}}}i._requestsInProgress=0;i._allInstances=[];n.ClientSideStorage=n.Old.ClientSideStorage})(i=t.ClientSideStorage||(t.ClientSideStorage={}))})(t=n.Old||(n.Old={}))}(WSB||(WSB={})),function(n){var t;(function(t){var i;(function(i){const r=250,u=3;class f{constructor(t,i,r,u,f){this._storageFactory=t;this.createResponse=i;this.dataPopulated=r;this.getDataSourceState=u;this._dataSource=f;this._pendingQueries=[];this._storageOpenInProgress=!1;this._retryCount=0;n.Host&&(n.Host.bindAppVisible(()=>this.initStorage()),n.Host.bindDismissed(()=>this._pendingQueries=[]),n.Host.bindAppHidden(()=>this.teardownStorage()))}onAfterWrite(){if(this._writing=!1,this._pendingWrites.length>0){let n=this._pendingWrites.shift();n()}else this._tearDownPending&&this.teardownStorage()}teardownStorage(){this._writing?this._tearDownPending=!0:(this._tearDownPending=!1,this._storage&&this._storage.close())}initStorage(){!this._storageOpenInProgress&&this.dataPopulated()&&(this._storageOpenInProgress=!0,this._storageFactory(n=>{this._storage=n,this._storageOpenInProgress=!1,this._pendingQueries.forEach(n=>n()),this._pendingQueries=[]},n=>{this.onError(n,"open storage");this._storageOpenInProgress=!1;this._pendingQueries.forEach(n=>n());this._pendingQueries=[]},()=>this._storage=null))}static getUnixTime(t){return t||(t=n.getCurrentDate()),Math.round(t.getTime()/1e3)}onError(n,t){t!="open storage"&&SharedLogHelper.LogError(t,this._dataSource,n);this.teardownStorage()}reloadStorage(){this.teardownStorage();this.initStorage()}isReady(){return!!this._storage}getTimeout(t,i){return!t||(i===null||i===void 0?void 0:i.isSearchHomeZI)?n.LatencyTimeout:r}getKey(n){return this._dataSource=="ANA"?"anaheimData":n.queryToFetch?n.queryToFetch.toLocaleLowerCase():""}fetch(i,r,u,f,e){let s=n.getCurrentTime();if(n.config.enableFetchStartLogging&&n.InstrumentationHelper.instrumentFetchProviderBegin(u,"SBDP:"+this._dataSource),n.isDataSourceEnabled(this._dataSource,i)){this._dataSource=="ANA"&&(t.AnaheimDataProvider.InstrumentStringNumber.FTC=1);let o=(t,u)=>{let f=n.getCurrentTime()-s;n.InstrumentationHelper.instrumentPerfEvent(n.SequenceNumberManager.getSequenceNumber(),"Fetch"+this._dataSource,f);let o=u=="R";e()&&r(this._dataSource,this.createResponse(i,t,o),this.getDataSourceState(u))};this.innerQueryStorage(1,this.getKey(i),n=>o(n,"R"),()=>o(null,"E"),()=>o(null,"X"),()=>o(null,"T"),i)}}withStorage(n){return this._storage?(n(this._storage),!0):!1}getMaxKey(n){return n.slice(0,n.length-1)+String.fromCharCode(n.charCodeAt(n.length-1)+1)}getStorage(n,t,i,r){this.innerQueryStorage(null,null,t=>n(t),t,i,r)}queryStorage(n,t,i,r,u){this.innerQueryStorage(0,n,t,i,r,u)}innerQueryStorage(t,r,f,e,o,s,h){let c=null,l=!1,a=!0,v=()=>{if(a)if(a=!1,this._storage){let n=n=>{(n===null||n===void 0?void 0:n.message)==="NotFoundError"&&(this._retryCount+=1);c&&sb_ct(c);this.onError(n,"query");l||(l=!0,e())};t==0?this._storage.getValue(r,n=>{c&&sb_ct(c),l||(l=!0,f(n))},n):r?this._storage.getRange(r,this.getMaxKey(r),n=>{c&&sb_ct(c),l||(l=!0,f(n))},n):this._storage.getAll(n=>{c&&sb_ct(c),l||(l=!0,f(n))},n)}else c&&sb_ct(c),l||(l=!0,e())};if(this._storage)v();else if(this._retryCount<u)if(this.initStorage(),this._storageOpenInProgress)this._pendingQueries.push(v);else{o();return}else{this._retryCount=0;let t=n.DataProviderDBName[this.getName()];this.onError(new Error("Corrupted "+t+". Will delete and reloading."),"IndexDBCorruption");i.deleteDatabase(t);return}let y=this.getTimeout(r,h);y&&(c=n.safeSetTimeout(()=>{c=null,a=!1,l||(l=!0,s())},y,"innerQueryStorage"))}}i.StorageBasedDataProvider=f})(i=t.ClientSideStorage||(t.ClientSideStorage={}))})(t=n.Old||(n.Old={}))}(WSB||(WSB={})),function(n){const t=3;class i{constructor(n,t){this._navigationHelper=n;this._temporaryMessageHandler=t}parse(i,r,u,f,e,o,s){let h=[],l=[],a=[],v=[],y=[],p=[],w=[],c=[];if(f&&f.Suggestions)for(let e of f.Suggestions){let f=e.suggestionData;if(f.handoffType==2){let t=f;n.isApp(f.type)?(l.push(t.id),y.push(e)):n.isSetting(f.type)?(a.push(t.id),p.push(e)):n.isFileOrFolder(f.type)&&(v.push(t.id),w.push(e))}else if(n.isBingEnabled()){if(n.config.msbMruLimitEnabled&&u==="MWS"&&i.scope===n.Scope.All&&h.length===t)break;let o=n.safeExecute(()=>this.parseMRUWebSuggestion(i,e,r,u),"parseMRUWebSuggestion");o&&(n.config.enableMruProviderInQF?i.isSearchHomeZI&&f.handoffType==0?c.push(o):h.push(o):f.handoffType==0?c.push(o):h.push(o))}}u!="MWS"&&(n.lookupById(i,"MPP",l,y,n=>[n.suggestionData.id],"MST",a,p,n=>n.suggestionData.id,e,r,o,s,(n,t,u,f)=>this.parseIdLookupResponse(i,r,n,t,u,f),"MFF",v,w,n=>n.suggestionData.id),n.isDataSourceEnabled("MRS",i)&&o("MRS",c,f));o(u,h,f)}parseIdLookupResponse(t,i,r,u,f,e){let o=r.suggestionData;if((n.MockUrlParameters===null||n.MockUrlParameters===void 0?void 0:n.MockUrlParameters.mockMRUDataFile)&&f.length==0){const t={displayName:o.id,id:o.id,kind:"document",getProperty:null,propertyHits:[],rankScore:1e3};f.push(n.createLocalResponseSuggestionWithDeviceItemImage(t,o.type,u))}if(f.length==1){let s=n=>(this.setupRemoveFromHistoryContextMenu(n,r,t),n.lastLaunchTime=r.rankingData.lastLaunchTime,o.appContextData&&(n.appContext=o.appContextData.appContext,n.query=o.appContextData.query,n.text=t.queryToFetch?HitHighlightingParser.addMarkers(o.appContextData.textWithoutHH,t.queryToFetch):o.appContextData.textWithoutHH),this.setRankingSignals(n,o),!0);n.safeExecute(()=>n.parseLocalSuggestion(t,f[0],u,i,this._temporaryMessageHandler,o.type,e,s),"parseLocalSuggestion "+u)}}setRankingSignals(n,t){n.hc=t.hc;n.highConfidenceMetaSuggestionScore=t.highConfidenceMetaSuggestionScore;n.prefetchConfidenceScore=t.prefetchConfidenceScore;n.fromHistory=!0;n.hasMruData=!0}parseMRUWebSuggestion(t,i,r,u){let e=i.suggestionData,f=n.createSuggestion(t,t.queryToFetch?HitHighlightingParser.addMarkers(e.textWithoutHH,t.queryToFetch):e.textWithoutHH,null,e.icon,e.type,e.query,n.InstrumentedItem.createInstrumentedItem(r,e.type),e.handoffType,r,!1);f.lastLaunchTime=i.rankingData.lastLaunchTime;this.setRankingSignals(f,e);switch(f.handoffType){case 5:case 4:if(!n.isCortanaEnabledCache||f.type=="CSK")return null;let o=e;if(f.primaryMetadata=o.annotation||o.secondaryText,f.reactKey=f.type+f.primaryMetadata,!n.setCat1SuggestionProperties(f,t,r,o.actionUri,o.taskFrame,o.confidence,o.source))return null;break;case 3:case 10:return null;case 0:case 13:case 14:case 21:case 17:if(!(n.isDataSourceEnabled("MRS",t)||n.isDataSourceEnabled("MWS",t)))return null;let c=e;(n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.features.isWorkMruEnabled())&&u=="MWS"&&(t.isWorkScopeZI||t.isSearchHomeZI)?n.msbHost.qfUtils.setMsbMruSuggestionProperties(f,e):(!t.isSearchHomeZI||t.scope==n.Scope.Web&&n.config.enableZeroInputSearchHomeWeb||(f=this.setTextAndIconForLBSHSuggestion(f,c)),n.setWebSearchSuggestionProperties(f,t,r,c.url,this._navigationHelper,null,!0));f.reactKey=this.generateReactKey(t,f);break;case 1:let s=e,l=i.rankingData;t.queryToFetch.length>3&&(f.autoOpenPreviewPaneWhenOnTopHit=!!l.previewPaneLaunchCount);let h=s.title||s.secondaryText;t.isSearchHomeZI&&h?(f.additionalInfoText=s.url,f.text=HitHighlightingParser.removeMarkers(h)):f.primaryMetadata=h;f.reactKey=s.type+s.url;n.setUrlSuggestionProperties(f,t,r,s.url);n.config.directNavPreviewPane&&f.type=="MD"&&f.url&&(f.getIcon=n.getFaviconUrlForRawUrl(f.url,64,64,1.5),t.isSearchHomeZI||(f.previewPaneType=2));break;default:return SharedLogHelper.LogError("parseMruWebSuggestion",null,new Error("Unexpected handoff type: "+e.handoffType)),null}return n.isValidSuggestion(f,"parseMruWebSuggestion")?(this.setupRemoveFromHistoryContextMenu(f,i,t),f):null}setTextAndIconForLBSHSuggestion(n,t){return n.text=t.query,n.icon=this.getIconForLBSHSuggestion(),n}getIconForLBSHSuggestion(){return n.config.disableMruLBSHColorfulIcon?{type:2,content:"&#xE721"}:{type:0,className:n.config.enableLBSHGradientIcon?"LBSHGradientSpyglass":n.config.enableLBSHSolidBlueIcon?"LBSHSolidBlueSpyglass":n.config.mirrorMruLBSHItemIcon?"LBSHSpyglassSV2":"LBSHSpyglass"}}setupRemoveFromHistoryContextMenu(t,i,r){n.RuntimeConfig.QfMode!=5&&n.RuntimeConfig.QfMode!=9&&i.remove&&n.setExtraVerbs(t,u=>{if(u||!i.remove)return[];if(!t.removeIcon&&t.duplicates&&t.duplicates.some(n=>!n.fromHistory))return[];const f=n.config.mruSearchHome&&(r.scope===n.Scope.All||r.scope===n.Scope.Work);let e={verb:f?"RemoveFromDeviceHistoryAll":"RemoveFromDeviceHistory",displayName:n.Host.getLocString("RemoveFromDeviceHistory"),executeSync:()=>{i.remove(()=>{t.handoffType!==2&&n.updateDismissedMruWebSugCache(t),n.Host.refreshCurrentPane(),f||this._temporaryMessageHandler.showTemporaryMessage(n.Host.getLocString("RemovedFromDeviceHistory",HitHighlightingParser.removeMarkers(t.text)))}),delete i.remove},icon:{content:"&#xE711",type:2}};return[e]},!0)}generateReactKey(t,i){return(t===null||t===void 0?void 0:t.isSearchHomeZI)?i.type+i.text:n.config.enableMruProviderInQF?i.type+i.query:i.type+t.fullPartialQuery}}n.MRUParser=i}(WSB||(WSB={})),function(n){var t;(function(t){var i;(function(i){const f=30,e=3,o=8,s=2,h=4,c=15,l="LastUpdated",u="MRUNoItemsAvailable";class r extends t.ClientSideStorage.StorageBasedDataProvider{static getMRUInstrumentationStringMap(){return r._instrumentedStrings}getName(){return this.dataSource==="MWS"?"MRUWorkSearchDataProvider":"MRUDataProvider"}constructor(i,r,u,f,e,o,s,h,c){i&&(i.bindItemLaunch((n,t,i)=>this.storeSuggestionToMRU(n,t,i)),i.bindConversationEnds((n,t,i)=>this.storeSuggestionToMRU(n,t,i)));let a,v=(t,i,u)=>r(o,i=>{t(i);let r=n.getTimeDiffInDays(a);(r===null||r>=1)&&(a=n.getCurrentDate(),this.prune());this.getStorage(n=>this.instrumentMRUSize(n),()=>this.onAfterWrite(),()=>this.onAfterWrite(),()=>this.onAfterWrite())},i,u,l),y=(t,i,r)=>(n.MockUrlParameters&&!n.MockUrlParameters.mockMRUDataOff&&(i=this.dataSource==="MWS"?n.MockedMSBMRUData:n.MockedMRUData),this.dataSource!=="MWS"||(n.msbHost===null||n.msbHost===void 0?void 0:n.msbHost.features.isWorkMruEnabled())||(i=[]),n.safeExecute